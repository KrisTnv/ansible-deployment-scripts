---

- hosts: all
  become: true
  #Tasks run before anything else in the playbook (No different than normal tasks: !)
  pre_tasks:

  - name: Install updates (RHEL)
    tags: always
    dnf:
      update_only: yes
      update_cache: yes
    when: ansible_distribution == "RedHat"

  - name: Install updates (CentOS)
    tags: always
    dnf:
      update_only: yes
      update_cache: yes
    when: ansible_distribution == "CentOS"

  - name: Install updates (Ubuntu)
    tags: always
    apt:
      upgrade: dist
      update_cache: yes
    when: ansible_distribution == "Ubuntu"

- hosts: all
  become: true
  vars: 
   user_name: hpc
   password: "{{ user_password }}"

  tasks:

  - name: create hpc user
    tags: always
    user:
      name: "{{ user_name }}"
      password: "{{ password | password_hash('sha512') }}"
      shell: /bin/bash
      groups: root

  - name: add ssh key for hpc
    tags: always
    authorized_key:
      user: hpc
      key: "{{ lookup('file', '/home/kristiyanslave/.ssh/id_rsa.pub') }}"

  - name: add sudoers file for hpc
    tags: always
    copy:
      src: /home/kristiyanslave/Ansible-scripts/files/sudoer_hpc
      dest: /etc/sudoers.d/hpc
      owner: root
      group: root
      mode: 0440
